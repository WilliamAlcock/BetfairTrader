package indicators

import org.scalatest.prop.TableDrivenPropertyChecks._

import org.scalatest.{Matchers, FlatSpec}

class ChaikinOscillatorSpec extends FlatSpec with Matchers with TestHelpers {
  val testData = Table(
    ("High",	"Low",	"Close",	"Volume",   "ADL",	      "3 Day EMA",	      "10 Day EMA",	      "Chaikin Oscillator", "oscillatorDelta"),
    (44.72,	  44.14,	44.54,	  4460900.0,	1692065.517,  None,               None,               None,                 None),
    (44.22,	  43.8,	  43.95,	  6834500.0,	-260648.7685, None,               None,               None,                 None),
    (44.14,	  43.57,	43.68,	  4323600.0,	-2915490.874,	Some(-494691.375),  None,               None,                 None),
    (43.44,	  42.59,	43.16,	  7933400.0,	-208801.462,	Some(-351746.4185), None,               None,                 None),
    (43.04,	  42.65,	42.7,	    6923500.0,	-5357045.052,	Some(-2854395.735), None,               None,                 None),
    (43.21,	  42.73,	43.05,	  4916900.0,	-3718078.385,	Some(-3286237.06),  None,               None,                 None),
    (43.05,	  42.54,	42.56,	  4439500.0,	-7809382.307,	Some(-5547809.683), None,               None,                 None),
    (43.23,	  42.39,	43.15,	  8960000.0,	-556048.9733,	Some(-3051929.328), None,               None,                 None),
    (42.73,	  41.95,	41.99,	  6970900.0,	-6811984.871,	Some(-4931957.1),   None,               None,                 None),
    (41.98,	  41.27,	41.54,	  7416700.0,	-8587814.448,	Some(-6759885.774),	Some(-3453322.962),	Some(-3306562.812),   None),
    (42.1,	  41.17,	41.22,	  5207000.0,	-13234921.98,	Some(-9997403.874),	Some(-5231795.51),	Some(-4765608.364),   Some(44.12574737)),
    (41.27,	  40.48,	40.61,	  8518800.0,	-18950066.28,	Some(-14473735.08),	Some(-7726026.559),	Some(-6747708.518),   Some(41.59175496)),
    (40.69,	  39.56,	40.63,	  10663400.0,	-9419062.739,	Some(-11946398.91),	Some(-8033851.319),	Some(-3912547.589),   Some(-42.01664789)),
    (40.98,	  39.45,	40.72,	  9972900.0,	-2835645.092,	Some(-7391022.0),	  Some(-7088722.914),	Some(-302299.0859),   Some(-92.27359977)),
    (41.7,	  41.23,	41.44,	  11108100.0,	-4017357.858,	Some(-5704189.929),	Some(-6530292.904),	Some(826102.9749),    Some(-373.273395)),
    (41.28,	  40.79,	41.16,	  6357400.0,	-773786.4294,	Some(-3238988.179),	Some(-5483655.363),	Some(2244667.184),    Some(171.7176008)),
    (42.39,	  41.67,	42.26,	  5479700.0,	2727133.015,	Some(-255927.582),	Some(-3990784.749),	Some(3734857.167),    Some(66.38801483)),
    (42.16,	  41.56,	41.56,	  5049000.0,	-2321866.985,	Some(-1288897.283),	Some(-3687345.155),	Some(2398447.872),    Some(-35.78207238)),
    (42.42,	  41.79,	42.17,	  4949300.0,	-1300582.858,	Some(-1294740.071),	Some(-3253388.374),	Some(1958648.303),    Some(-18.33684083)),
    (42.21,	  41.79,	42.17,	  4358500.0,	2227726.666,	Some(466493.2976),	Some(-2256822.003),	Some(2723315.301),    Some(39.04054628)),
    (42.01,	  41.53,	41.95,	  7010200.0,	7485376.666,	Some(3975934.982),	Some(-485513.1542),	Some(4461448.136),    Some(63.82414973)),
    (42.86,	  42.13,	42.84,	  7427800.0,	14506173.93,	Some(9241054.454),	Some(2240248.133),	Some(7000806.321),    Some(56.91780129)),
    (43.5,	  42.62,	42.9,	    7344300.0,	11835519.38,	Some(10538286.92),	Some(3984842.905),	Some(6553444.012),    Some(-6.390154054)),
    (43.27,	  42.44,	43.11,	  6651300.0,	15922462.75,	Some(13230374.84),	Some(6155319.242),	Some(7075055.594),    Some(7.959350554)),
    (43.47,	  42.69,	43.46,	  7493700.0,	23224016.6,	  Some(18227195.72),	Some(9258718.761),	Some(8968476.957),    Some(26.76192911)),
    (43.08,	  42.43,	42.46,	  6742000.0,	17104355.06,	Some(17665775.39),	Some(10685198.09),	Some(6980577.301),    Some(-22.16540963)),
    (42.02,	  41.4,	  41.65,	  8031000.0,	15549967.97,	Some(16607871.68),	Some(11569701.7),	  Some(5038169.975),    Some(-27.82588377)),
    (41.92,	  41.25,	41.77,	  5316100.0,	18485724.68,	Some(17546798.18),	Some(12827160.43),	Some(4719637.753),    Some(-6.322379416)),
    (42.11,	  41.54,	41.87,	  4523700.0,	19199993.1,	  Some(18373395.64),	Some(13985857.28),	Some(4387538.365),    Some(-7.036544034)),
    (42.34,	  41.94,	42.06,	  5702100.0,	16919153.1,	  Some(17646274.37),	Some(14519183.79),	Some(3127090.582),    Some(-28.7279034)),
    (42.25,	  41.77,	41.86,	  5072400.0,	13748903.1,	  Some(15697588.74),	Some(14379132.76),	Some(1318455.981),    Some(-57.83761465)),
    (41.92,	  41.31,	41.75,	  5421800.0,	16148716.22,	Some(15923152.48),	Some(14700875.2),	  Some(1222277.274),    Some(-7.294798523)),
    (41.56,	  41.12,	41.18,	  6101900.0,	11710970.76,	Some(13817061.62),	Some(14157256.21),	Some(-340194.5943),   Some(-127.8328495)),
    (40.86,	  40.46,	40.67,	  8572200.0,	12139580.76,	Some(12978321.19),	Some(13790406.13),	Some(-812084.9408),   Some(138.7118886)),
    (41.03,	  40.39,	40.94,	  5525600.0,	16111105.76,	Some(14544713.48),	Some(14212351.52),	Some(332361.9575),    Some(-140.9269943)),
    (41.04,	  40.51,	40.9,	    4577000.0,	18270068.03,	Some(16407390.75),	Some(14950118.16),	Some(1457272.595),    Some(338.4595053)),
    (41.4,	  40.97,	41.19,	  4250500.0,	18368916.86,	Some(17388153.81),	Some(15571717.92),	Some(1816435.886),    Some(24.64626676)),
    (41.72,	  41.16,	41.54,	  4540400.0,	19990488.29,	Some(18689321.05),	Some(16375130.72),	Some(2314190.334),    Some(27.40280852)),
    (41.89,	  41.46,	41.77,	  3864000.0,	21697837.13,	Some(20193579.09),	Some(17342895.52),	Some(2850683.571),    Some(23.18276201)),
    (42.51,	  42.1,	  42.42,	  5918100.0,	25017746.89,	Some(22605662.99),	Some(18738323.04),	Some(3867339.948),    Some(35.66359967)),
    (42.47,	  41.91,	42.04,	  5473700.0,	22085407.6,	  Some(22345535.29),	Some(19346883.87),	Some(2998651.425),    Some(-22.46217128)),
    (42.06,	  41.52,	41.57,	  6256500.0,	16987518.71,	Some(19666527.0),	  Some(18917908.39),	Some(748618.6166),    Some(-75.03482364)),
    (41.73,	  41.4,	  41.59,	  3441900.0,	17509018.71,	Some(18587772.86),	Some(18661746.63),	Some(-73973.77005),   Some(-109.8813693)),
    (39.93,	  39.19,	39.32,	  13950700.0,	8459916.009,	Some(13523844.43),	Some(16806868.33),	Some(-3283023.9),     Some(4338.091904)),
    (39.9,	  38.87,	39.83,	  14091000.0,	20635634.46,	Some(17079739.44),	Some(17503007.63),	Some(-423268.1838),   Some(-87.10736819)),
    (41.2,	  39.8,	  40.72,	  12932100.0,	24700008.74,	Some(20889874.09),	Some(18811553.28),	Some(2078320.808),    Some(-591.017489)),
    (41.59,	  40.75,	41.31,	  7502200.0,	27200742.07,	Some(24045308.08),	Some(20336860.34),	Some(3708447.746),    Some(78.43480815)),
    (40.62,	  40.04,	40.39,	  8242900.0,	28906169.66,	Some(26475738.87),	Some(21894916.58),	Some(4580822.294),    Some(23.52398113)),
    (40.23,	  39.81,	39.98,	  6906600.0,	27590626.8,	  Some(27033182.84),	Some(22930500.26),	Some(4102682.582),    Some(-10.43785768)),
    (39.58,	  38.77,	38.87,	  10641900.0,	19576356.43,	Some(23304769.64),	Some(22320655.92),	Some(984113.7113),    Some(-76.01292102)),
    (39.13,	  38.08,	38.52,	  12161200.0,	17607400.24,	Some(20456084.94),	Some(21463700.35),	Some(-1007615.407),   Some(-202.3881077)),
    (38.26,	  37.5,	  37.74,	  10584600.0,	13707810.77,	Some(17081947.85),	Some(20053538.6),	  Some(-2971590.75),    Some(194.9131912)),
    (37.98,	  37.3,	  37.33,	  9744000.0,	4823575.475,	Some(10952761.66),	Some(17284454.4),	  Some(-6331692.735),   Some(113.0741837)),
    (37.11,	  36.24,	36.24,	  12180400.0,	-7356824.525,	Some(1797968.57),	  Some(12804221.87),	Some(-11006253.3),    Some(73.82797554)),
    (36.34,	  34.88,	34.94,	  16107200.0,	-22140145.07,	Some(-10171088.25),	Some(6450700.605),	Some(-16621788.86),   Some(51.02131859)),
    (36.55,	  34.9,	  35.76,	  17575300.0,	-21394526.29,	Some(-15782807.27),	Some(1387932.08),	  Some(-17170739.35),   Some(3.302595743)),
    (37.75,	  35.87,	37.69,	  14429700.0,	-7885870.966,	Some(-11834339.12),	Some(-298213.9285),	Some(-11536125.19),   Some(-32.81520991)),
    (38.35,	  37.66,	38.32,	  15596000.0,	6353955.121,	Some(-2740191.998),	Some(911271.3532),	Some(-3651463.351),   Some(-68.34757519)),
    (39.42,	  38.49,	39.4,	    10832400.0,	16720445.44,	Some(6990126.723),	Some(3785666.642),	Some(3204460.08),     Some(-187.758243)),
    (39.27,	  38.6,	  39.1,	    10179500.0,	21734229.03,	Some(14362177.87),	Some(7049041.621),	Some(7313136.253),    Some(128.2174241)),
    (39.28,	  38.61,	39.12,	  7831000.0,	25825049.92,	Some(20093613.9),	  Some(10462861.31),	Some(9630752.586),    Some(31.69114115)),
    (39.27,	  38.78,	38.95,	  3484400.0,	24758396.86,	Some(22426005.38),	Some(13062049.59),	Some(9363955.785),    Some(-2.770259104)),
    (39.15,	  38.78,	38.98,	  5986800.0,	25243813.08,	Some(23834909.23),	Some(15276915.68),	Some(8557993.546),    Some(-8.607070105))
  )

  case class Data(tick: Tick, accumulationDistribution: AccumulationDistribution, chaikinOscillator: ChaikinOscillator) extends ChaikinOscillatorData

  "Chaikin Oscillator" should "produce the correct figures" in {
    var prevData = List.empty[Data]

    forAll(testData) {(high: Double, low: Double, close: Double, volume: Double, accDistLine: Double, firstEMA: Option[Double], secondEMA: Option[Double], oscillator: Option[Double], oscillatorDelta: Option[Double]) =>
      val tick = Tick.getNext(close, Range(high, low), volume, 0.0, prevData)
      val accumulationDistribution = AccumulationDistribution.getNext(tick, prevData)
      val chaikinOscillator = ChaikinOscillator.getNext(accumulationDistribution, prevData)

      accumulationDistribution.line should be(accDistLine +- 0.1)
      matchOptionDouble(chaikinOscillator.firstEMAofADL, firstEMA, 0.01)
      matchOptionDouble(chaikinOscillator.secondEMAofADL, secondEMA, 0.01)
      matchOptionDouble(chaikinOscillator.oscillator, oscillator, 0.1)
      matchOptionDouble(chaikinOscillator.oscillatorDelta, oscillatorDelta, 0.000001)
      prevData = Data(tick, accumulationDistribution, chaikinOscillator) :: prevData
    }
  }
}

